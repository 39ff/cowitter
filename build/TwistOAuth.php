<?php abstract class twistbase{final protected static function filter($input,$array_demention=0){$array_demention=(int)$array_demention;if($array_demention<1){switch(true){case is_array($input):case is_object($input)and!method_exists($input,'__toString'):return '';}return (string)$input;}$output=array();foreach((array)$input as $key=>$value){$output[self::filter($key)]=self::filter($array_demention-1);}return $output;}}class twistconsumer extends twistbase{private $consumerkey='';private $consumersecret='';private $requesttoken='';private $requesttokensecret='';private $accesstoken='';private $accesstokensecret='';private $screenname='';private $userid='';private $useragent='TwistOAuth';private $history=array();private $cookies=array();public function __construct($consumerkey='',$consumersecret='',$accesstoken='',$accesstokensecret=''){$this->setconsumer($consumerkey,$consumersecret)->setaccesstoken($accesstoken,$accesstokensecret);}public function __tostring(){$string='';if($this->screenname!==''){$string.=$this->screenname;}if($this->userid!==''){$string.="({$this->userid})";}return $string;}final public function __get($name){if(!property_exists($this,$name=self::filter($name))){throw new outofrangeexception("Invalid property name: {$name}");}return $this->$name;}public function setconsumer($consumerkey='',$consumersecret=''){$this->consumerkey=self::filter($consumerkey);$this->consumersecret=self::filter($consumersecret);return $this;}public function setrequesttoken($requesttoken='',$requesttokensecret=''){$this->requesttoken=self::filter($requesttoken);$this->requesttokensecret=self::filter($requesttokensecret);return $this;}public function setaccesstoken($accesstoken='',$accesstokensecret=''){$this->accesstoken=self::filter($accesstoken);$this->accesstokensecret=self::filter($accesstokensecret);return $this;}public function setcredential($userid='',$screenname=''){$this->userid=self::filter($userid);$this->screenname=self::filter($screenname);return $this;}public function setuseragent($useragent){$this->useragent=self::filter($useragent);return $this;}public function getauthorizeurl($force_login=false){return $this->getauthurl('authorize',$force_login);}public function getauthenticateurl($force_login=false){return $this->getauthurl('authenticate',$force_login);}public function sethistory($name){$name=self::filter($name);$this->history+=array($name=>0);++$this->history[$name];return $this;}public function setcookie($key,$value){$this->cookies[self::filter($key)]=self::filter($value);return $this;}private function getauthurl($mode,$force_login){$url="https://api.twitter.com/oauth/{$mode}";$params=array('oauth_token'=>$this->request_token,'force_login'=>$force_login?'1':null );return $url.'?'.http_build_query($params,'','&');}}class twistexception extends runtimeexception{protected $request=null;public function __construct($message,$code,twistrequest $request=null){$this->request=$request;parent::__construct($message,$code);}public function __tostring(){return sprintf('[%d] %s',$this->getcode(),$this->getmessage());}public function getrequest(){return $this->request;}}class twistexecuter extends twistunserializable{const step_write_request_headers=0;const step_read_response_headers=1;const step_read_response_longed=2;const step_read_response_chunked_size=3;const step_read_response_chunked_content=4;const step_finished=5;private $jobs=array();private $timeout=1.0;public function __construct($args){if(!$args=func_get_args()){throw new invalidargumentexception('Required at least 1 TwistReuest instance.');}$this->jobs=array();array_walk_recursive($args,array($this,'setRequest'));}final public function settimeout($sec=1.0){$this->timeout=abs((float)$sec);return $this;}final public function start(){foreach($this->jobs as $job){self::initialize($job);switch(true){case!($job->request instanceof twistrequest):case!($job->request->consumer instanceof twistconsumer):continue 2;case!$fp=fsockopen("ssl://{$job->request->host}",443):case!stream_set_blocking($fp,0):throw new twistexception("Failed to connect: {$job->request->host}",0,$job->request);default:$job->step=self::step_write_request_headers;$job->fp=$fp;}}return $this;}final public function abort(){foreach($this->jobs as $job){self::initialize($job);}return $this;}final public function isrunning(){foreach($this->jobs as $job){if($job->step!==self::step_finished){return true;}}return false;}final public function run(){$read=$write=$results=array();$except=null;foreach($this->jobs as $i=>$job){switch($job->step){case self::step_finished:continue 2;case self::step_write_request_headers:$write[$i]=$job->fp;continue 2;default:$read[$i]=$job->fp;}}if(!$read and!$write){return $results;}$sec=(int)$this->timeout;$msec=(int)($this->timeout*1000000)%1000000;if(false===stream_select($read,$write,$except,$sec,$msec)){throw new twistexception('Failed to select stream.',0);}foreach($this->jobs as $job){switch($job->step){case self::step_write_request_headers:self::writerequestheaders($job);break;case self::step_read_response_headers:self::readresponseheaders($job);break;case self::step_read_response_chunked_size:self::readresponsechunkedsize($job);break;case self::step_read_response_longed:if(null!==$result=self::readresponselonged($job)){$results[]=$job->request->setresponse($result);}break;case self::step_read_response_chunked_content:if(null!==$result=self::readresponsechunkedcontent($job)){$results[]=$job->request->setresponse($result);}}}return $results;}private function setrequest(twistrequest $request){$job=self::initialize();$job->request=$request;$this->jobs[]=$job;}private static function initialize(stdclass $job=null){if($job===null){$job=new stdclass;}$job->step=self::step_finished;$job->fp=false;$job->size='';$job->buffer='';$job->incomplete='';$job->length=0;$job->info=array();return $job;}private static function writerequestheaders(stdclass $job){if($job->buffer===''){$job->buffer=$job->request->buildheaders();}if(false!==$tmp=fwrite($job->fp,$job->buffer)){$job->buffer=(string)substr($job->buffer,$tmp);}if($job->buffer===''){$job->step=$job->request->waitresponse?self::step_read_response_headers:self::step_finished;}$job->request->consumer->sethistory($job->request->endpoint);return;}private static function readresponseheaders(stdclass $job){if(is_string($buffers=self::freaduntilseparator($job->fp,$job->buffer,"\r\n\r\n"))){$job->buffer=$buffers;return;}foreach(explode("\r\n",$buffers[0])as $i=>$line){self::readresponseheader($job,$i,$line);}if(!empty($job->info['content-length'])){$job->step=self::step_read_response_longed;$job->buffer=$buffers[1];$job->length=$job->info['content-length'];}elseif(isset($job->info['transfer-encoding'])){$job->step=self::step_read_response_chunked_size;$job->buffer='';$job->length=0;$job->size=$buffers[1];}else{throw new twistexception('Detected malformed response header.',(int)$job->info['code'],$job->request);}}private static function readresponselonged(stdclass $job){if(is_string($buffers=self::freaduntillength($job->fp,$job->buffer,$job->length))){$job->buffer=$buffers;return;}$job->step=self::step_finished;$buffers[0]=gzinflate(substr($buffers[0],10,-8));$buffers[0]=self::decode($job,$buffers[0]);self::initialize($job);return $buffers[0];}private static function readresponsechunkedsize(stdclass $job){if(is_string($buffers=self::freaduntilseparator($job->fp,$job->size,"\r\n"))){$job->size=$buffers;return;}switch(true){case $buffers[0]==='0':$job->step=self::step_finished;$job->buffer='';$job->size='';$job->incomplete='';$job->length=0;return;case $buffers[0]==='':case 2===$tmp=hexdec($buffers[0])+2:throw new twistexception('Detected malformed response body.',(int)$job->info['code'],$job->request);default:$job->step=self::step_read_response_chunked_content;$job->buffer=$buffers[1];$job->size='';$job->length=$tmp;}}private static function readresponsechunkedcontent(stdclass $job){if(is_string($buffers=self::freaduntillength($job->fp,$job->buffer,$job->length))){$job->buffer=$buffers;return;}$buffers[0]=substr($buffers[0],0,-2);$job->buffer='';$job->length=0;$job->step=self::step_read_response_chunked_size;if(substr($buffers[0],-2)==="\r\n"){$value=$job->incomplete.substr($buffers[0],0,-2);$job->size=$buffers[1];$job->incomplete='';return self::decode($job,$value);}$job->size=$buffers[1];$job->incomplete=$buffers[0];return;}private static function readresponseheader(stdclass $job,$offset,$line){if($offset){list($key,$value)=explode(': ',$line,2)+array(1=>'');$key=strtolower($key);switch($key){case 'set-cookie':list($k,$v)=explode('=',$line,2)+array(1=>'');list($v)=explode(";",$v);$job->request->consumer->setcookie($k,$v);break;default:$job->info[$key]=$value;}}else{list($protocol,$code,$message)=explode(' ',$line,3)+array(1=>'0',2=>'');$job->info+=compact('protocol','code','memssage');}}private static function freaduntilseparator($fp,$buffer,$separator){while(true){$items=explode($separator,$buffer,2);if(isset($items[1])){return $items;}if(isset($retry)){return $buffer;}$buffer.=$tmp=fread($fp,8192);$retry=true;}}private static function freaduntillength($fp,$buffer,$length){while(true){if($length<=strlen($buffer)){return array((string)substr($buffer,0,$length),(string)substr($buffer,$length));}if(isset($retry)){return $buffer;}$buffer.=$tmp=fread($fp,8192);$retry=true;}}private static function decode(stdclass $job,$value){switch(true){case null!==$object=json_decode($value):case false!==$object=json_decode(json_encode(@simplexml_load_string($value))):case!parse_str($value,$object)and $object=(object)$object and isset($object->oauth_token,$object->oauth_token_secret):case preg_match("@<title>Error \d++ ([^<]++)</title>@",$value,$m)and $object=(object)array('error'=>$m[1]):case!isset($job->info['content-type'])||$job->info['content-type']!=='application/json'and $object=(object)array('error'=>trim(strip_tags($value))):case $object=(object)array('error'=>"Unknown error on parsing: {$value}"):}if(isset($object->oauth_token,$object->oauth_token_secret)){if(isset($object->screen_name,$object->user_id)){$job->request->consumer->screenname=$object->screen_name;$job->request->consumer->userid=$object->userid;}if($job->endpoint==='/oauth/request_token'){$job->request->consumer->requesttoken=$object->oauth_token;$job->request->consumer->requesttokensecret=$object->oauth_token_secret;}if($job->endpoint==='/oauth/access_token'){$job->request->consumer->accesstoken=$object->oauth_token;$job->request->consumer->accesstokensecret=$object->oauth_token_secret;}}if(isset($job->info['x-twitter-new-account-oauth-access-token'],$job->info['x-twitter-new-account-oauth-secret'])){$object->oauth_token=$job->info['x-twitter-new-account-oauth-access-token'];$object->oauth_token_secret=$job->info['x-twitter-new-account-oauth-secret'];}switch(true){case isset($object->errors)and is_array($object->errors):$object->errors=$object->errors[0]->message;case isset($object->errors)and is_string($object->errors):$object->error=$object->errors;case isset($object->error):$object=new twistexception($object->error,(int)$job->info['code'],$job->request);}if($object instanceof twistexception and $job->request->throw){throw $object;}return $object;}}class twistiterator extends twistexecuter implements iterator{private $responses=array();private $callback;private $args=array();private $interval=0;private $timer=0;public function setinterval($callback,$interval=0,array $args=array()){if(!is_callable($callback)){throw invalidargumentexception('Invalid callback passed.');}$this->interval=abs((float)$sec);$this->args=$args;return $this;}public function rewind(){$this->responses=array();return $this->start();}public function valid(){if(false!==$tmp=current($this->responses)){return true;}$this->responses=array();while(!$this->responses and $this->isrunning()){$this->responses=$this->run();}return (bool)$this->responses;}public function key(){return '';}public function current(){if($this->callback){$time=microtime(true);$this->timer-=$time;if($this->timer<=0){$this->timer=$this->interval;call_user_func_array($this->callback,$this->args);}}return current($this->responses);}public function next(){next($this->responses);return $this;}}class twistrequest extends twistbase{private $host;private $endpoint;private $method;private $extraparams;private $streaming;private $multipart;private $waitresponse;private $throw;private $consumer;private $params=array();private $response;public static function get($endpoint='',$params=array(),twistconsumer $consumer=null){$args=get_defined_vars();$args+=array('method'=>'GET','waitResponse'=>true,'throw'=>false,);return new self($args);}public static function getauto($endpoint='',$params=array(),twistconsumer $consumer=null){$args=get_defined_vars();$args+=array('method'=>'GET','waitResponse'=>true,'throw'=>true,);return new self($args);}public static function post($endpoint='',$params=array(),twistconsumer $consumer=null){$args=get_defined_vars();$args+=array('method'=>'POST','waitResponse'=>true,'throw'=>false,);return new self($args);}public static function postauto($endpoint='',$params=array(),twistconsumer $consumer=null){$args=get_defined_vars();$args+=array('method'=>'POST','waitResponse'=>true,'throw'=>true,);return new self($args);}public static function send($endpoint='',$params=array(),twistconsumer $consumer=null){$args=get_defined_vars();$args+=array('method'=>'POST','waitResponse'=>false,'throw'=>false,);return new self($args);}final public function __get($name){if(!property_exists($this,$name=self::filter($name))){throw new outofrangeexception("Invalid property name: {$name}");}return $this->$name;}public function setparams($params=array()){$this->params=is_array($params)?self::filter($params,1):self::parsequery(self::filter($params));return $this;}public function setconsumer(twistconsumer $consumer=null){$this->consumer=$consumer;return $this;}public function setresponse($body=null){$this->response=$body;return $this;}public function execute(){foreach(new twistiterator($this)as $result){return $result;}}final public function buildheaders(){if(!($this->consumer instanceof twistconsumer)){throw new badmethodcallexception('Headers cannot be built without TwistConsumer instance.');}$params=$this->solveparams();$content=$this->buildoauthpart($params);$connection=$this->streaming?'keep-alive':'close';$user_agent=urlencode($this->consumer->useragent);if($this->method==='GET'){if(''!==$query=self::buildquery($params)){$content.="&{$query}";}$lines=array("{$this->method} {$this->endpoint}?{$content} HTTP/1.1","Host: {$this->host}","User-Agent: {$user_agent}","Connection: {$connection}","","",);}elseif(!$this->multipart){if(''!==$query=self::buildquery($params)){$content.="&{$query}";}$length=strlen($content);$lines=array("{$this->method} {$this->endpoint} HTTP/1.1","Host: {$this->host}","User-Agent: {$user_agent}","Connection: {$connection}","Content-Type: application/x-www-form-urlencoded","Content-Length: {$length}","",$content,);}else{$boundary='--------------------'.sha1(mt_rand().microtime());$authorization=implode(', ',explode('&',$content));$content=self::buildmultipartcontent($params,$boundary);$length=strlen($content);$lines=array("{$this->method} {$this->endpoint} HTTP/1.1","Host: {$this->host}","User-Agent: {$user_agent}","Connection: {$connection}","Authorization: OAuth {$authorization}","Content-Type: multipart/form-data; boundary={$boundary}","Content-Length: {$length}","",$content,);}if(!$this->streaming){array_splice($lines,3,0,"Accept-Encoding: deflate, gzip");}return implode("\r\n",$lines);}private static function buildmultipartcontent(array $params,$boundary){$lines=array();foreach($params as $key=>$value){if($key==='media[]'){$filename=md5(mt_rand().microtime());$disposition="form-data; name=\"{$key}\"; filename=\"{$filename}\"";}else{$disposition="form-data; name=\"{$key}\"";}array_push($lines,"--{$boundary}","Content-Disposition: {$disposition}","Content-Type: application/octet-stream","",$value);}$lines[]="--{$boundary}--";return implode("\r\n",$lines);}private static function buildquery(array $params,$pair=true){$new=array();foreach($params as $key=>$value){$value=str_replace('%7E','~',rawurlencode($value));$new[$key]=$pair?"{$key}={$value}":$value;}uksort($new,'strnatcmp');return implode('&',$new);}private static function parsequery($query){foreach(explode('&',$query)as $pair){list($k,$v)=explode('=',$pair,2)+array(1=>'');$params[$k]=$v;}if($params===array(''=>'')){$params=array();}return $params;}private function __construct(array $args){$this->setendpoint($args['endpoint']);$this->setparams($args['params']);$this->setconsumer($args['consumer']);$this->method=$args['method'];$this->waitresponse=$args['waitResponse'];$this->throw=$args['throw'];}private function setendpoint($endpoint){static $streamings=array('filter','sample','firehose');$endpoint=self::filter($endpoint);switch(true){case!$p=parse_url($endpoint):case!isset($p['path']):case!$count=preg_match_all('/(?![\d.])[\w.]++/',$p['path'],$parts):throw new invalidargumentexception("invalid endpoint: {$endpoint}");}$streaming=$multipart=$old=!$host='api.twitter.com';foreach($parts[0]as $i=>&$part){$part=strtolower($part);if($count===$i+1){switch(true){case $parts[0][0]==='oauth2':throw new invalidargumentexception("this library does not support OAuth 2.0 authentication");case $parts[0][0]==='oauth':$part=basename($part,'.json');break 2;case $old=$parts[0][0]==='urls'and $host='urls.api.twitter.com':case $old=$parts[0][0]==='generate':case $streaming=$parts[0][0]==='user'and $host='userstream.twitter.com':case $streaming=$parts[0][0]==='site'and $host='sitestream.twitter.com':case $streaming=in_array($part,$streamings)and $host='stream.twitter.com':default:$multipart=$part==='update_with_media';$part=basename($part,'.json').'.json';array_splice($parts[0],0,0,$old?'1':'1.1');break 2;}}}$this->host=$host;$this->endpoint='/'.implode('/',$parts[0]);$this->extraparams=isset($p['query'])?self::parsequery($p['query']):array();$this->streaming=$streaming;$this->multipart=$multipart;return $this;}private function solveparams(){$new=array();$params=$this->params+$this->extraparams;foreach($params as $key=>$value){if($value===null){continue;}if($value===false){$value='0';}$value=self::filter($value);if(strpos($key,'@')===0){if(!is_readable($value)or!is_file($value)){throw new invalidargumentexception("File not found: {$value}");}$key=(string)substr($key,1);$value=file_get_contents($value);if(!$this->multipart){$value=base64_encode($value);}}$new[$key]=$value;}return $new;}private function buildoauthpart(array&$params){$bodies=array('oauth_consumer_key'=>$this->consumer->consumerkey,'oauth_signature_method'=>'HMAC-SHA1','oauth_timestamp'=>time(),'oauth_version'=>'1.0a','oauth_nonce'=>sha1(mt_rand().microtime()),);$keys=array($this->consumer->consumersecret,'');if($this->endpoint==='/oauth/access_token'){$bodies['oauth_token']=$consumer->requesttoken;if(isset($params['oauth_verifier'])){$bodies['oauth_verifier']=$params['oauth_verifier'];unset($params['oauth_verifier']);}$keys[1]=$this->consumer->requesttokensecret;}elseif($this->endpoint!=='/oauth/request_token'){$bodies['oauth_token']=$this->consumer->accesstoken;$keys[1]=$this->consumer->accesstokensecret;}$copy=$bodies;if(!$this->multipart){$copy+=$params;}$url="https://{$this->host}{$this->endpoint}";$copy=self::buildquery(array($this->method,$url,self::buildquery($copy)),false);$keys=self::buildquery($keys,false);$bodies['oauth_signature']=base64_encode(hash_hmac('sha1',$copy,$keys,true));return self::buildquery($bodies);}}abstract class twistunserializable{final public function __sleep(){throw new badmethodcallexception('This object cannot be serialized.');}final public function __wakeup(){throw new badmethodcallexception('This serial cannot be unserialized.');}}